
Этот документ описывает внутреннюю механику работы бота NaviBot – инструмента для расчёта стоимости аренды теплоходов. Здесь подробно описаны:
  
1. Формат входящего запроса к боту  
2. Алгоритм расчёта стоимости аренды, включая особенности расчёта технических часов  
3. Формирование ответа бота  
4. Механизм загрузки и обновления данных из Excel (файл `rental_data.xlsx`)

> **Важно:** В этой версии документации не рассматривается форматирование ответа (выделение жирным через звёздочки) – его реализация будет добавлена на следующем этапе разработки.

---

## 1. Формат входящего запроса

Запрос к боту должен соответствовать одному из следующих форматов (каждый блок запроса – отдельное сообщение):

### 1.1. Формат с четырьмя временными значениями (основной интервал плюс технические часы)

Пример:

```
07.09.25

Антверпен
21:30-22:30-02:30-03:00
```

**Описание:**

- **Первая строка:** Дата в формате `dd.mm.yy` (например, `07.09.25`).
- **Вторая строка:** Название теплохода (например, `Антверпен`). Сравнение названий происходит без учёта регистра и с учётом эквивалентности букв "е" и "ё".
- **Третья строка:** Интервал времени, разделённый дефисами. Если указано 4 значения, они соответствуют:
  - Время начала подготовки (технический интервал до посадки)
  - Время начала посадки (начало основного интервала)
  - Время высадки (конец основного интервала)
  - Время начала разгрузки (технический интервал после высадки)

### 1.2. Формат с двумя временными значениями

Пример:

```
07.09.25

Антверпен
21:30-02:30
```

**Описание:**

- Если указано только 2 значения, то они считаются временем начала и окончания основного интервала (без технических часов). То есть на теплоходе не будет подготовки и разгрузки мероприятия.
---

## 2. Алгоритм расчёта стоимости аренды

### 2.1. Источник данных

- **Данные загружаются из файла `rental_data.xlsx`**, который содержит два листа:
  - **"Теплоходы":** С информацией о теплоходах (название, ссылка, адрес причала, стоимость уборки и т.д.).
  - **"Цены":** С тарифами. Для каждой записи указаны:
    - Название теплохода
    - Дата начала и окончания действия тарифа
    - День недели (или диапазон дней)
    - Временной интервал (например, `10:00 - 18:00`)
    - Тариф в руб/ч

- Данные из Excel загружаются один раз и кэшируются для повышения производительности. По команде `/update_data` бот обновляет кэш (перечитывает данные из файла).

### 2.2. Выбор тарифных строк

При расчёте бот:
  
1. Фильтрует записи по названию теплохода. При этом сравнение происходит без учёта регистра и с эквивалентностью букв "е" и "ё".  
2. Проверяет, попадает ли дата запроса (boarding_date) в диапазон дат, указанный в тарифной строке (используются столбцы "Дата начала" и "Дата окончания").  
3. Определяет сокращённое название дня недели для даты запроса (например, "Пн" для понедельника) и проверяет, соответствует ли оно значению в столбце "День недели" (которое может быть задано как диапазон, например, "Пн-Чт", или перечень).

### 2.3. Разбиение запрошенного времени и применение коэффициента для технических часов

В зависимости от формата запроса:

- **Если указаны 4 временных значения:**
  - Первый сегмент: время подготовки — интервал от начала до начала посадки.
  - Второй сегмент: основной интервал — от начала посадки до начала высадки.
  - Третий сегмент: время разгрузки — от начала высадки до времени начала разгрузки.
  
  Для сегментов, относящихся к техническим интервалам (подготовка и разгрузка), применяется коэффициент 0.5. Это означает, что для расчёта берётся только половина фактического времени технического сегмента (а не делится стоимость за час).

- **Если указаны 2 временных значения:**
  - Используется только основной интервал, без отдельных технических сегментов.

### 2.4. Расчёт стоимости

Для каждого сегмента происходит следующее:

1. Для выбранного теплохода и даты определяется список тарифных строк, удовлетворяющих условиям (см. пункт 2.2).
2. Для каждого тарифного интервала определяется, какое время из запрошенного сегмента пересекается с ним.
3. Если происходит пересечение:
   - Для **основного интервала** пересекающееся время умножается на полный тариф (руб/ч).
   - Для **технических интервалов** (подготовка и разгрузка) пересекающееся время умножается на коэффициент 0.5 и затем на тариф.
4. Стоимость всех сегментов суммируется.
5. К сумме добавляется фиксированная стоимость уборки (либо значение берётся из базы для конкретного теплохода, либо используется значение по умолчанию).

### 2.5. Агрегация и итоговый расчёт

- После расчёта стоимости для каждого сегмента бот формирует подробное представление (breakdown) расчёта по каждому тарифу, например:  
  `(16000₽/ч x 4.75ч) + (15000₽/ч x 1.5ч)`
- Итоговая стоимость складывается из стоимости всех сегментов плюс стоимость уборки.
- Результат форматируется: числа выводятся с пробелами для разделения тысяч (например, 43 000₽).

---

## 3. Формирование ответа бота

После выполнения расчёта бот формирует ответ, который содержит следующие блоки:

1. **Дата запроса:**  
   Отображается в первой строке в формате `dd.mm.yy`.

2. **Название теплохода и ссылка:**  
   Во второй строке выводится название теплохода и ссылка на страницу, где можно получить дополнительную информацию.

3. **Расписание этапов:**  
   Каждая последующая строка содержит:
   - Время начала каждого этапа:
     - Подготовка (50% времени технического интервала)
     - Посадка (начало основного интервала)
     - Высадка (конец основного интервала)
     - Разгрузка (50% времени технического интервала)
   - Название этапа (например, "Подготовка (50%)").

4. **Причал:**  
   Указывается адрес причала, где происходит высадка/разгрузка.

5. **Подробный расчёт аренды:**  
   Здесь выводится разбивка расчёта стоимости аренды, включающая стоимость каждого сегмента и итоговую сумму (сумма стоимости всех сегментов плюс уборка).

*Пример ответа :*

```
07.09.25

Антверпен - https://teplohod-restoran.ru/product/antverpen/
21:30 - Подготовка (50%)
22:30 - Посадка
02:30 - Высадка
03:00 - Разгрузка (50%)
Причал: Наб. Фонтанки 177
Аренда: (16 000₽/ч x 4.75ч) + 3000₽ (уборка) = 79 000₽
```

Каждый элемент ответа помогает пользователю быстро понять расчёт и детали процесса аренды.

---

## 4. Обновление данных

Бот загружает данные из файла `rental_data.xlsx` при первом обращении и кэширует их. Для обновления данных используется команда: /update_data

После её выполнения бот заново загружает данные из Excel и обновляет кэш. Это позволяет актуализировать тарифы и информацию о теплоходах без перезапуска всего приложения.

---

## 5. Примечания по дальнейшему обновлению документации

- Данная документация должна поддерживаться в актуальном состоянии. При добавлении новых функций или изменении существующих алгоритмов следует вносить соответствующие правки в этот файл.
- Каждый раздел можно дополнить датой обновления и кратким описанием внесённых изменений.
- В случае изменения формата запроса или логики расчёта, необходимо обновлять пункты 1 и 2, чтобы документация всегда отражала текущую реализацию.

---

*Эта документация описывает внутреннюю механику работы бота NaviBot и предназначена для разработчиков и администраторов, чтобы обеспечить стабильную работу и облегчить внесение изменений в будущем.*